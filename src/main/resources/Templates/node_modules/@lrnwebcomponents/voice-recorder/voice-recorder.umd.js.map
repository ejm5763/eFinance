{"version":3,"file":"voice-recorder.umd.js","sources":["lib/vmsg-fork.js","voice-recorder.umd.js"],"sourcesContent":["/* eslint-disable */\n\nfunction pad2(n) {\n  n |= 0;\n  return n < 10 ? `0${n}` : `${Math.min(n, 99)}`;\n}\n\nfunction inlineWorker() {\n  // TODO(Kagami): Cache compiled module in IndexedDB? It works in FF\n  // and Edge, see: https://github.com/mdn/webassembly-examples/issues/4\n  // Though gzipped WASM module currently weights ~70kb so it should be\n  // perfectly cached by the browser itself.\n  function fetchAndInstantiate(url, imports) {\n    if (!WebAssembly.instantiateStreaming)\n      return fetchAndInstantiateFallback(url, imports);\n    const req = fetch(url, { credentials: \"same-origin\" });\n    return WebAssembly.instantiateStreaming(req, imports).catch(err => {\n      // https://github.com/Kagami/vmsg/issues/11\n      if (\n        err.message &&\n        err.message.indexOf(\n          \"Argument 0 must be provided and must be a Response\"\n        ) > 0\n      ) {\n        return fetchAndInstantiateFallback(url, imports);\n      } else {\n        throw err;\n      }\n    });\n  }\n\n  function fetchAndInstantiateFallback(url, imports) {\n    return new Promise((resolve, reject) => {\n      const req = new XMLHttpRequest();\n      req.open(\"GET\", url);\n      req.responseType = \"arraybuffer\";\n      req.onload = () => {\n        resolve(WebAssembly.instantiate(req.response, imports));\n      };\n      req.onerror = reject;\n      req.send();\n    });\n  }\n\n  // Must be in sync with emcc settings!\n  const TOTAL_STACK = 5 * 1024 * 1024;\n  const TOTAL_MEMORY = 16 * 1024 * 1024;\n  const WASM_PAGE_SIZE = 64 * 1024;\n  let memory = null;\n  let dynamicTop = TOTAL_STACK;\n  // TODO(Kagami): Grow memory?\n  function sbrk(increment) {\n    const oldDynamicTop = dynamicTop;\n    dynamicTop += increment;\n    return oldDynamicTop;\n  }\n  // TODO(Kagami): LAME calls exit(-1) on internal error. Would be nice\n  // to provide custom DEBUGF/ERRORF for easier debugging. Currenty\n  // those functions do nothing.\n  function exit(status) {\n    postMessage({ type: \"internal-error\", data: status });\n  }\n\n  let FFI = null;\n  let ref = null;\n  let pcm_l = null;\n  function vmsg_init(rate) {\n    ref = FFI.vmsg_init(rate);\n    if (!ref) return false;\n    const pcm_l_ref = new Uint32Array(memory.buffer, ref, 1)[0];\n    pcm_l = new Float32Array(memory.buffer, pcm_l_ref);\n    return true;\n  }\n  function vmsg_encode(data) {\n    pcm_l.set(data);\n    return FFI.vmsg_encode(ref, data.length) >= 0;\n  }\n  function vmsg_flush() {\n    if (FFI.vmsg_flush(ref) < 0) return null;\n    const mp3_ref = new Uint32Array(memory.buffer, ref + 4, 1)[0];\n    const size = new Uint32Array(memory.buffer, ref + 8, 1)[0];\n    const mp3 = new Uint8Array(memory.buffer, mp3_ref, size);\n    const blob = new Blob([mp3], { type: \"audio/mpeg\" });\n    FFI.vmsg_free(ref);\n    ref = null;\n    pcm_l = null;\n    return blob;\n  }\n\n  // https://github.com/brion/min-wasm-fail\n  function testSafariWebAssemblyBug() {\n    const bin = new Uint8Array([\n      0,\n      97,\n      115,\n      109,\n      1,\n      0,\n      0,\n      0,\n      1,\n      6,\n      1,\n      96,\n      1,\n      127,\n      1,\n      127,\n      3,\n      2,\n      1,\n      0,\n      5,\n      3,\n      1,\n      0,\n      1,\n      7,\n      8,\n      1,\n      4,\n      116,\n      101,\n      115,\n      116,\n      0,\n      0,\n      10,\n      16,\n      1,\n      14,\n      0,\n      32,\n      0,\n      65,\n      1,\n      54,\n      2,\n      0,\n      32,\n      0,\n      40,\n      2,\n      0,\n      11\n    ]);\n    const mod = new WebAssembly.Module(bin);\n    const inst = new WebAssembly.Instance(mod, {});\n    // test storing to and loading from a non-zero location via a parameter.\n    // Safari on iOS 11.2.5 returns 0 unexpectedly at non-zero locations\n    return inst.exports.test(4) !== 0;\n  }\n\n  onmessage = e => {\n    const msg = e.data;\n    switch (msg.type) {\n      case \"init\":\n        const { wasmURL, shimURL } = msg.data;\n        Promise.resolve()\n          .then(() => {\n            if (self.WebAssembly && !testSafariWebAssemblyBug()) {\n              delete self.WebAssembly;\n            }\n            if (!self.WebAssembly) {\n              importScripts(shimURL);\n            }\n            memory = new WebAssembly.Memory({\n              initial: TOTAL_MEMORY / WASM_PAGE_SIZE,\n              maximum: TOTAL_MEMORY / WASM_PAGE_SIZE\n            });\n            return {\n              memory: memory,\n              pow: Math.pow,\n              exit: exit,\n              powf: Math.pow,\n              exp: Math.exp,\n              sqrtf: Math.sqrt,\n              cos: Math.cos,\n              log: Math.log,\n              sin: Math.sin,\n              sbrk: sbrk\n            };\n          })\n          .then(Runtime => {\n            return fetchAndInstantiate(wasmURL, { env: Runtime });\n          })\n          .then(wasm => {\n            FFI = wasm.instance.exports;\n            postMessage({ type: \"init\", data: null });\n          })\n          .catch(err => {\n            postMessage({ type: \"init-error\", data: err.toString() });\n          });\n        break;\n      case \"start\":\n        if (!vmsg_init(msg.data))\n          return postMessage({ type: \"error\", data: \"vmsg_init\" });\n        break;\n      case \"data\":\n        if (!vmsg_encode(msg.data))\n          return postMessage({ type: \"error\", data: \"vmsg_encode\" });\n        break;\n      case \"stop\":\n        const blob = vmsg_flush();\n        if (!blob) return postMessage({ type: \"error\", data: \"vmsg_flush\" });\n        postMessage({ type: \"stop\", data: blob });\n        break;\n    }\n  };\n}\n\nexport class Recorder {\n  constructor(opts = {}, onStop = null) {\n    // Can't use relative URL in blob worker, see:\n    // https://stackoverflow.com/a/22582695\n    this.wasmURL = new URL(\n      opts.wasmURL || \"/static/js/vmsg.wasm\",\n      location\n    ).href;\n    this.shimURL = new URL(\n      opts.shimURL || \"/static/js/wasm-polyfill.js\",\n      location\n    ).href;\n    this.onStop = onStop;\n    this.pitch = opts.pitch || 0;\n    this.stream = null;\n    this.audioCtx = null;\n    this.gainNode = null;\n    this.pitchFX = null;\n    this.encNode = null;\n    this.worker = null;\n    this.workerURL = null;\n    this.blob = null;\n    this.blobURL = null;\n    this.resolve = null;\n    this.reject = null;\n    Object.seal(this);\n  }\n\n  close() {\n    if (this.encNode) this.encNode.disconnect();\n    if (this.encNode) this.encNode.onaudioprocess = null;\n    if (this.stream) this.stopTracks();\n    if (this.audioCtx) this.audioCtx.close();\n    if (this.worker) this.worker.terminate();\n    if (this.workerURL) URL.revokeObjectURL(this.workerURL);\n    if (this.blobURL) URL.revokeObjectURL(this.blobURL);\n  }\n\n  // Without pitch shift:\n  //   [sourceNode] -> [gainNode] -> [encNode] -> [audioCtx.destination]\n  //                                     |\n  //                                     -> [worker]\n  // With pitch shift:\n  //   [sourceNode] -> [gainNode] -> [pitchFX] -> [encNode] -> [audioCtx.destination]\n  //                                                  |\n  //                                                  -> [worker]\n  initAudio() {\n    const getUserMedia =\n      navigator.mediaDevices && navigator.mediaDevices.getUserMedia\n        ? function(constraints) {\n            return navigator.mediaDevices.getUserMedia(constraints);\n          }\n        : function(constraints) {\n            const oldGetUserMedia =\n              navigator.webkitGetUserMedia || navigator.mozGetUserMedia;\n            if (!oldGetUserMedia) {\n              return Promise.reject(\n                new Error(\"getUserMedia is not implemented in this browser\")\n              );\n            }\n            return new Promise(function(resolve, reject) {\n              oldGetUserMedia.call(navigator, constraints, resolve, reject);\n            });\n          };\n\n    return getUserMedia({ audio: true }).then(stream => {\n      this.stream = stream;\n      const audioCtx = (this.audioCtx = new (window.AudioContext ||\n        window.webkitAudioContext)());\n\n      const sourceNode = audioCtx.createMediaStreamSource(stream);\n      const gainNode = (this.gainNode = (\n        audioCtx.createGain || audioCtx.createGainNode\n      ).call(audioCtx));\n      gainNode.gain.value = 1;\n      sourceNode.connect(gainNode);\n\n      const pitchFX = (this.pitchFX = new Jungle(audioCtx));\n      pitchFX.setPitchOffset(this.pitch);\n\n      const encNode = (this.encNode = (\n        audioCtx.createScriptProcessor || audioCtx.createJavaScriptNode\n      ).call(audioCtx, 0, 1, 1));\n      pitchFX.output.connect(encNode);\n\n      gainNode.connect(this.pitch === 0 ? encNode : pitchFX.input);\n    });\n  }\n\n  initWorker() {\n    if (!this.stream) throw new Error(\"missing audio initialization\");\n    // https://stackoverflow.com/a/19201292\n    const blob = new Blob([\"(\", inlineWorker.toString(), \")()\"], {\n      type: \"application/javascript\"\n    });\n    const workerURL = (this.workerURL = URL.createObjectURL(blob));\n    const worker = (this.worker = new Worker(workerURL));\n    const { wasmURL, shimURL } = this;\n    worker.postMessage({ type: \"init\", data: { wasmURL, shimURL } });\n    return new Promise((resolve, reject) => {\n      worker.onmessage = e => {\n        const msg = e.data;\n        switch (msg.type) {\n          case \"init\":\n            resolve();\n            break;\n          case \"init-error\":\n            reject(new Error(msg.data));\n            break;\n          // TODO(Kagami): Error handling.\n          case \"error\":\n          case \"internal-error\":\n            console.error(\"Worker error:\", msg.data);\n            if (this.reject) this.reject(msg.data);\n            break;\n          case \"stop\":\n            this.blob = msg.data;\n            this.blobURL = URL.createObjectURL(msg.data);\n            if (this.onStop) this.onStop();\n            if (this.resolve) this.resolve(this.blob);\n            break;\n        }\n      };\n    });\n  }\n\n  init() {\n    return this.initAudio().then(this.initWorker.bind(this));\n  }\n\n  startRecording() {\n    if (!this.stream) throw new Error(\"missing audio initialization\");\n    if (!this.worker) throw new Error(\"missing worker initialization\");\n    this.blob = null;\n    if (this.blobURL) URL.revokeObjectURL(this.blobURL);\n    this.blobURL = null;\n    this.resolve = null;\n    this.reject = null;\n    this.worker.postMessage({ type: \"start\", data: this.audioCtx.sampleRate });\n    this.encNode.onaudioprocess = e => {\n      const samples = e.inputBuffer.getChannelData(0);\n      this.worker.postMessage({ type: \"data\", data: samples });\n    };\n    this.encNode.connect(this.audioCtx.destination);\n  }\n\n  stopRecording() {\n    if (!this.stream) throw new Error(\"missing audio initialization\");\n    if (!this.worker) throw new Error(\"missing worker initialization\");\n    this.encNode.disconnect();\n    this.encNode.onaudioprocess = null;\n    this.stopTracks();\n    this.worker.postMessage({ type: \"stop\", data: null });\n    return new Promise((resolve, reject) => {\n      this.resolve = resolve;\n      this.reject = reject;\n    });\n  }\n\n  stopTracks() {\n    // Might be missed in Safari and old FF/Chrome per MDN.\n    if (this.stream.getTracks) {\n      // Hide browser's recording indicator.\n      this.stream.getTracks().forEach(track => track.stop());\n    }\n  }\n}\n\nexport class Form {\n  constructor(opts = {}, target = document.body, resolve, reject) {\n    this.recorder = new Recorder(opts, this.onStop.bind(this));\n    this.resolve = resolve;\n    this.reject = reject;\n    this.target = target;\n    this.renderArea = null;\n    this.recordBtn = null;\n    this.stopBtn = null;\n    this.timer = null;\n    this.audio = null;\n    this.saveBtn = null;\n    this.tid = 0;\n    this.start = 0;\n    Object.seal(this);\n\n    this.recorder\n      .initAudio()\n      .then(() => this.drawInit())\n      .then(() => this.recorder.initWorker())\n      .then(() => this.drawAll())\n      .catch(err => this.drawError(err));\n  }\n\n  drawInit() {\n    const renderArea = (this.renderArea = document.createElement(\"div\"));\n    renderArea.className = \"vmsg-popup\";\n    renderArea.addEventListener(\"click\", e => e.stopPropagation());\n\n    const progress = document.createElement(\"div\");\n    progress.className = \"vmsg-progress\";\n    for (let i = 0; i < 3; i++) {\n      const progressDot = document.createElement(\"div\");\n      progressDot.className = \"vmsg-progress-dot\";\n      progress.appendChild(progressDot);\n    }\n    renderArea.appendChild(progress);\n\n    this.target.appendChild(renderArea);\n  }\n\n  drawTime(msecs) {\n    const secs = Math.round(msecs / 1000);\n    this.timer.textContent = pad2(secs / 60) + \":\" + pad2(secs % 60);\n  }\n\n  drawAll() {\n    this.drawInit();\n    this.clearAll();\n\n    const recordRow = document.createElement(\"div\");\n    recordRow.className = \"vmsg-record-row\";\n    this.renderArea.appendChild(recordRow);\n    // @todo make this point to the parent button somehow that invoked this for events\n    const recordBtn = (this.recordBtn = document.createElement(\"button\"));\n    recordBtn.className = \"vmsg-button vmsg-record-button\";\n    recordBtn.textContent = \"●\";\n    recordBtn.addEventListener(\"click\", () => this.startRecording());\n    recordRow.appendChild(recordBtn);\n\n    const stopBtn = (this.stopBtn = document.createElement(\"button\"));\n    stopBtn.className = \"vmsg-button vmsg-stop-button\";\n    stopBtn.style.display = \"none\";\n    stopBtn.textContent = \"■\";\n    stopBtn.addEventListener(\"click\", () => this.stopRecording());\n    recordRow.appendChild(stopBtn);\n\n    const audio = (this.audio = new Audio());\n    audio.autoplay = true;\n\n    const timer = (this.timer = document.createElement(\"span\"));\n    timer.className = \"vmsg-timer\";\n    timer.addEventListener(\"click\", () => {\n      if (audio.paused) {\n        if (this.recorder.blobURL) {\n          audio.src = this.recorder.blobURL;\n        }\n      } else {\n        audio.pause();\n      }\n    });\n    this.drawTime(0);\n    recordRow.appendChild(timer);\n\n    const saveBtn = (this.saveBtn = document.createElement(\"button\"));\n    saveBtn.className = \"vmsg-button vmsg-save-button\";\n    saveBtn.textContent = \"✓\";\n    saveBtn.disabled = true;\n    saveBtn.addEventListener(\"click\", () => this.close(this.recorder.blob));\n    recordRow.appendChild(saveBtn);\n\n    const gainWrapper = document.createElement(\"div\");\n    gainWrapper.className = \"vmsg-slider-wrapper vmsg-gain-slider-wrapper\";\n    const gainSlider = document.createElement(\"input\");\n    gainSlider.className = \"vmsg-slider vmsg-gain-slider\";\n    gainSlider.setAttribute(\"type\", \"range\");\n    gainSlider.min = 0;\n    gainSlider.max = 2;\n    gainSlider.step = 0.2;\n    gainSlider.value = 1;\n    gainSlider.onchange = () => {\n      const gain = +gainSlider.value;\n      this.recorder.gainNode.gain.value = gain;\n    };\n    gainWrapper.appendChild(gainSlider);\n    this.renderArea.appendChild(gainWrapper);\n\n    const pitchWrapper = document.createElement(\"div\");\n    pitchWrapper.className = \"vmsg-slider-wrapper vmsg-pitch-slider-wrapper\";\n    const pitchSlider = document.createElement(\"input\");\n    pitchSlider.className = \"vmsg-slider vmsg-pitch-slider\";\n    pitchSlider.setAttribute(\"type\", \"range\");\n    pitchSlider.min = -1;\n    pitchSlider.max = 1;\n    pitchSlider.step = 0.2;\n    pitchSlider.value = this.recorder.pitch;\n    pitchSlider.onchange = () => {\n      const pitch = +pitchSlider.value;\n      this.recorder.pitchFX.setPitchOffset(pitch);\n      this.recorder.gainNode.disconnect();\n      this.recorder.gainNode.connect(\n        pitch === 0 ? this.recorder.encNode : this.recorder.pitchFX.input\n      );\n    };\n    pitchWrapper.appendChild(pitchSlider);\n    this.renderArea.appendChild(pitchWrapper);\n    // trigger an event on our target instance that says we are ready\n    this.target.dispatchEvent(\n      new CustomEvent(\"vmsg-ready\", {\n        detail: {\n          value: true\n        }\n      })\n    );\n  }\n\n  drawError(err) {\n    console.error(err);\n    this.drawInit();\n    this.clearAll();\n    const error = document.createElement(\"div\");\n    error.className = \"vmsg-error\";\n    error.textContent = err.toString();\n    this.renderArea.appendChild(error);\n  }\n\n  clearAll() {\n    if (!this.renderArea) return;\n    this.renderArea.innerHTML = \"\";\n  }\n\n  close(blob) {\n    if (this.audio) this.audio.pause();\n    if (this.tid) clearTimeout(this.tid);\n    this.recorder.close();\n    if (blob) {\n      this.resolve(blob);\n    } else {\n      this.reject(new Error(\"No record made\"));\n    }\n  }\n\n  onStop() {\n    this.recordBtn.style.display = \"\";\n    this.stopBtn.style.display = \"none\";\n    this.stopBtn.disabled = false;\n    this.saveBtn.disabled = false;\n  }\n\n  startRecording() {\n    this.audio.pause();\n    this.start = Date.now();\n    this.updateTime();\n    this.recordBtn.style.display = \"none\";\n    this.stopBtn.style.display = \"\";\n    this.saveBtn.disabled = true;\n    this.recorder.startRecording();\n  }\n\n  stopRecording() {\n    clearTimeout(this.tid);\n    this.tid = 0;\n    this.stopBtn.disabled = true;\n    this.recorder.stopRecording();\n  }\n\n  updateTime() {\n    // NOTE(Kagami): We can do this in `onaudioprocess` but that would\n    // run too often and create unnecessary DOM updates.\n    this.drawTime(Date.now() - this.start);\n    this.tid = setTimeout(() => this.updateTime(), 300);\n  }\n}\n\nlet shown = false;\n\n/**\n * Record a new voice message.\n *\n * @param {Object=} opts - Options\n * @param {string=} opts.wasmURL - URL of the module\n *                                 (\"/static/js/vmsg.wasm\" by default)\n * @param {string=} opts.shimURL - URL of the WebAssembly polyfill\n *                                 (\"/static/js/wasm-polyfill.js\" by default)\n * @param {number=} opts.pitch - Initial pitch shift ([-1, 1], 0 by default)\n * @return {Promise.<Blob>} A promise that contains recorded blob when fulfilled.\n */\nexport function record(opts, target) {\n  return new Promise((resolve, reject) => {\n    if (shown) throw new Error(\"Record form is already opened\");\n    shown = true;\n    new Form(opts, target, resolve, reject);\n    // Use `.finally` once it's available in Safari and Edge.\n  }).then(\n    result => {\n      shown = false;\n      return result;\n    },\n    err => {\n      shown = false;\n      throw err;\n    }\n  );\n}\n\n/**\n * All available public items.\n */\nexport default { Recorder, Form, record };\n\n// Borrowed from and slightly modified:\n// https://github.com/cwilso/Audio-Input-Effects/blob/master/js/jungle.js\n\n// Copyright 2012, Google Inc.\n// All rights reserved.\n//\n// Redistribution and use in source and binary forms, with or without\n// modification, are permitted provided that the following conditions are\n// met:\n//\n//     * Redistributions of source code must retain the above copyright\n// notice, this list of conditions and the following disclaimer.\n//     * Redistributions in binary form must reproduce the above\n// copyright notice, this list of conditions and the following disclaimer\n// in the documentation and/or other materials provided with the\n// distribution.\n//     * Neither the name of Google Inc. nor the names of its\n// contributors may be used to endorse or promote products derived from\n// this software without specific prior written permission.\n//\n// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n// \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n// LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n// A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n// OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n// LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n// DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n// THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n\nconst delayTime = 0.1;\nconst fadeTime = 0.05;\nconst bufferTime = 0.1;\n\nfunction createFadeBuffer(context, activeTime, fadeTime) {\n  var length1 = activeTime * context.sampleRate;\n  var length2 = (activeTime - 2 * fadeTime) * context.sampleRate;\n  var length = length1 + length2;\n  var buffer = context.createBuffer(1, length, context.sampleRate);\n  var p = buffer.getChannelData(0);\n\n  var fadeLength = fadeTime * context.sampleRate;\n\n  var fadeIndex1 = fadeLength;\n  var fadeIndex2 = length1 - fadeLength;\n\n  // 1st part of cycle\n  for (var i = 0; i < length1; ++i) {\n    var value;\n\n    if (i < fadeIndex1) {\n      value = Math.sqrt(i / fadeLength);\n    } else if (i >= fadeIndex2) {\n      value = Math.sqrt(1 - (i - fadeIndex2) / fadeLength);\n    } else {\n      value = 1;\n    }\n\n    p[i] = value;\n  }\n\n  // 2nd part\n  for (var i = length1; i < length; ++i) {\n    p[i] = 0;\n  }\n\n  return buffer;\n}\n\nfunction createDelayTimeBuffer(context, activeTime, fadeTime, shiftUp) {\n  var length1 = activeTime * context.sampleRate;\n  var length2 = (activeTime - 2 * fadeTime) * context.sampleRate;\n  var length = length1 + length2;\n  var buffer = context.createBuffer(1, length, context.sampleRate);\n  var p = buffer.getChannelData(0);\n\n  // 1st part of cycle\n  for (var i = 0; i < length1; ++i) {\n    if (shiftUp)\n      // This line does shift-up transpose\n      p[i] = (length1 - i) / length;\n    // This line does shift-down transpose\n    else p[i] = i / length1;\n  }\n\n  // 2nd part\n  for (var i = length1; i < length; ++i) {\n    p[i] = 0;\n  }\n\n  return buffer;\n}\n\nfunction Jungle(context) {\n  this.context = context;\n  // Create nodes for the input and output of this \"module\".\n  var input = (context.createGain || context.createGainNode).call(context);\n  var output = (context.createGain || context.createGainNode).call(context);\n  this.input = input;\n  this.output = output;\n\n  // Delay modulation.\n  var mod1 = context.createBufferSource();\n  var mod2 = context.createBufferSource();\n  var mod3 = context.createBufferSource();\n  var mod4 = context.createBufferSource();\n  this.shiftDownBuffer = createDelayTimeBuffer(\n    context,\n    bufferTime,\n    fadeTime,\n    false\n  );\n  this.shiftUpBuffer = createDelayTimeBuffer(\n    context,\n    bufferTime,\n    fadeTime,\n    true\n  );\n  mod1.buffer = this.shiftDownBuffer;\n  mod2.buffer = this.shiftDownBuffer;\n  mod3.buffer = this.shiftUpBuffer;\n  mod4.buffer = this.shiftUpBuffer;\n  mod1.loop = true;\n  mod2.loop = true;\n  mod3.loop = true;\n  mod4.loop = true;\n\n  // for switching between oct-up and oct-down\n  var mod1Gain = (context.createGain || context.createGainNode).call(context);\n  var mod2Gain = (context.createGain || context.createGainNode).call(context);\n  var mod3Gain = (context.createGain || context.createGainNode).call(context);\n  mod3Gain.gain.value = 0;\n  var mod4Gain = (context.createGain || context.createGainNode).call(context);\n  mod4Gain.gain.value = 0;\n\n  mod1.connect(mod1Gain);\n  mod2.connect(mod2Gain);\n  mod3.connect(mod3Gain);\n  mod4.connect(mod4Gain);\n\n  // Delay amount for changing pitch.\n  var modGain1 = (context.createGain || context.createGainNode).call(context);\n  var modGain2 = (context.createGain || context.createGainNode).call(context);\n\n  var delay1 = (context.createDelay || context.createDelayNode).call(context);\n  var delay2 = (context.createDelay || context.createDelayNode).call(context);\n  mod1Gain.connect(modGain1);\n  mod2Gain.connect(modGain2);\n  mod3Gain.connect(modGain1);\n  mod4Gain.connect(modGain2);\n  modGain1.connect(delay1.delayTime);\n  modGain2.connect(delay2.delayTime);\n\n  // Crossfading.\n  var fade1 = context.createBufferSource();\n  var fade2 = context.createBufferSource();\n  var fadeBuffer = createFadeBuffer(context, bufferTime, fadeTime);\n  fade1.buffer = fadeBuffer;\n  fade2.buffer = fadeBuffer;\n  fade1.loop = true;\n  fade2.loop = true;\n\n  var mix1 = (context.createGain || context.createGainNode).call(context);\n  var mix2 = (context.createGain || context.createGainNode).call(context);\n  mix1.gain.value = 0;\n  mix2.gain.value = 0;\n\n  fade1.connect(mix1.gain);\n  fade2.connect(mix2.gain);\n\n  // Connect processing graph.\n  input.connect(delay1);\n  input.connect(delay2);\n  delay1.connect(mix1);\n  delay2.connect(mix2);\n  mix1.connect(output);\n  mix2.connect(output);\n\n  // Start\n  var t = context.currentTime + 0.05;\n  var t2 = t + bufferTime - fadeTime;\n  mod1.start(t);\n  mod2.start(t2);\n  mod3.start(t);\n  mod4.start(t2);\n  fade1.start(t);\n  fade2.start(t2);\n\n  this.mod1 = mod1;\n  this.mod2 = mod2;\n  this.mod1Gain = mod1Gain;\n  this.mod2Gain = mod2Gain;\n  this.mod3Gain = mod3Gain;\n  this.mod4Gain = mod4Gain;\n  this.modGain1 = modGain1;\n  this.modGain2 = modGain2;\n  this.fade1 = fade1;\n  this.fade2 = fade2;\n  this.mix1 = mix1;\n  this.mix2 = mix2;\n  this.delay1 = delay1;\n  this.delay2 = delay2;\n\n  this.setDelay(delayTime);\n}\n\nJungle.prototype.setDelay = function(delayTime) {\n  this.modGain1.gain.setTargetAtTime(0.5 * delayTime, 0, 0.01);\n  this.modGain2.gain.setTargetAtTime(0.5 * delayTime, 0, 0.01);\n};\n\nJungle.prototype.setPitchOffset = function(mult) {\n  if (mult > 0) {\n    // pitch up\n    this.mod1Gain.gain.value = 0;\n    this.mod2Gain.gain.value = 0;\n    this.mod3Gain.gain.value = 1;\n    this.mod4Gain.gain.value = 1;\n  } else {\n    // pitch down\n    this.mod1Gain.gain.value = 1;\n    this.mod2Gain.gain.value = 1;\n    this.mod3Gain.gain.value = 0;\n    this.mod4Gain.gain.value = 0;\n  }\n  this.setDelay(delayTime * Math.abs(mult));\n};\n","/**\n * Copyright 2019 The Pennsylvania State University\n * @license Apache-2.0, see License.md for full text.\n */\nimport { LitElement, html, css } from \"lit-element/lit-element.js\";\nimport { record } from \"./lib/vmsg-fork.js\";\n\n/**\n * `voice-recorder`\n * `LAME bridge`\n *\n * @demo demo/index.html\n * @element voice-recorder\n */\nclass VoiceRecorder extends LitElement {\n  static get styles() {\n    return [\n      css`\n        :host {\n          display: inline-flex;\n        }\n      `\n    ];\n  }\n  render() {\n    return html`\n      <button @click=\"${this.recordState}\">\n        <iron-icon icon=\"${this.iconState}\"></iron-icon>${this.textState}\n      </button>\n      <slot></slot>\n    `;\n  }\n  static get properties() {\n    return {\n      iconState: {\n        type: String\n      },\n      textState: {\n        type: String\n      },\n      recording: {\n        type: Boolean\n      }\n    };\n  }\n  /**\n   * Convention we use\n   */\n  static get tag() {\n    return \"voice-recorder\";\n  }\n\n  /**\n   * HTMLElement\n   */\n  constructor() {\n    super();\n    this.recording = false;\n    setTimeout(() => {\n      import(\"@polymer/iron-icon/iron-icon.js\");\n      import(\"@polymer/iron-icons/av-icons.js\");\n      this.addEventListener(\"vmsg-ready\", this.vmsgReady.bind(this));\n    }, 0);\n  }\n  recordState(e) {\n    this.recording = !this.recording;\n  }\n  /**\n   * LitElement life cycle - property changed\n   */\n  updated(changedProperties) {\n    changedProperties.forEach((oldValue, propName) => {\n      if (propName == \"recording\") {\n        if (this[propName]) {\n          this.textState = \"stop\";\n          this.iconState = \"av:stop\";\n        } else {\n          this.textState = \"Record\";\n          this.iconState = \"av:play-arrow\";\n        }\n        // observer to act on the recording piece\n        this.toggleRecording(this[propName], oldValue);\n      }\n    });\n  }\n  vmsgReady(e) {\n    console.log(e.detail.value);\n  }\n  /**\n   * Toggle the LAME bridge\n   */\n  toggleRecording(newValue, oldValue) {\n    if (newValue) {\n      // need to start...\n      record(\n        {\n          wasmURL:\n            this.pathFromUrl(decodeURIComponent(import.meta.url)) +\n            \"../../node_modules/vmsg/vmsg.wasm\"\n        },\n        this\n      ).then(blob => {\n        this.dispatchEvent(\n          new CustomEvent(\"voice-recorder-recording\", {\n            value: blob\n          })\n        );\n      });\n    }\n  }\n  pathFromUrl(url) {\n    return url.substring(0, url.lastIndexOf(\"/\") + 1);\n  }\n}\ncustomElements.define(VoiceRecorder.tag, VoiceRecorder);\nexport { VoiceRecorder };\n"],"names":["pad2","n","Math","min","inlineWorker","fetchAndInstantiateFallback","url","imports","Promise","resolve","reject","req","XMLHttpRequest","open","responseType","onload","WebAssembly","instantiate","response","onerror","send","memory","dynamicTop","sbrk","increment","oldDynamicTop","exit","status","postMessage","type","data","FFI","ref","pcm_l","onmessage","e","msg","wasmURL","shimURL","then","bin","mod","self","Uint8Array","Module","Instance","exports","test","importScripts","Memory","initial","TOTAL_MEMORY","maximum","pow","powf","exp","sqrtf","sqrt","cos","log","sin","Runtime","instantiateStreaming","fetch","credentials","err","message","indexOf","fetchAndInstantiate","env","wasm","instance","toString","rate","vmsg_init","pcm_l_ref","Uint32Array","buffer","Float32Array","set","vmsg_encode","length","blob","vmsg_flush","mp3_ref","size","mp3","Blob","vmsg_free","Recorder","opts","onStop","URL","location","href","pitch","stream","audioCtx","gainNode","pitchFX","encNode","worker","workerURL","blobURL","Object","seal","this","disconnect","onaudioprocess","stopTracks","close","terminate","revokeObjectURL","navigator","mediaDevices","getUserMedia","constraints","oldGetUserMedia","webkitGetUserMedia","mozGetUserMedia","call","Error","audio","_this","window","AudioContext","webkitAudioContext","sourceNode","createMediaStreamSource","createGain","createGainNode","gain","value","connect","Jungle","setPitchOffset","createScriptProcessor","createJavaScriptNode","output","input","createObjectURL","Worker","console","error","_this2","initAudio","initWorker","bind","sampleRate","samples","inputBuffer","getChannelData","_this3","destination","_this4","getTracks","forEach","track","stop","Form","target","document","body","recorder","renderArea","recordBtn","stopBtn","timer","saveBtn","tid","start","_this5","drawInit","drawAll","drawError","createElement","className","addEventListener","stopPropagation","progress","i","progressDot","appendChild","msecs","secs","round","textContent","clearAll","recordRow","_this6","startRecording","style","display","stopRecording","Audio","autoplay","paused","src","pause","drawTime","disabled","gainWrapper","gainSlider","setAttribute","max","step","onchange","pitchWrapper","pitchSlider","dispatchEvent","CustomEvent","detail","innerHTML","clearTimeout","Date","now","updateTime","setTimeout","_this7","shown","delayTime","fadeTime","bufferTime","createDelayTimeBuffer","context","activeTime","shiftUp","length1","createBuffer","p","mod1","createBufferSource","mod2","mod3","mod4","shiftDownBuffer","shiftUpBuffer","loop","mod1Gain","mod2Gain","mod3Gain","mod4Gain","modGain1","modGain2","delay1","createDelay","createDelayNode","delay2","fade1","fade2","fadeBuffer","fadeLength","fadeIndex1","fadeIndex2","createFadeBuffer","mix1","mix2","t","currentTime","t2","setDelay","prototype","setTargetAtTime","mult","abs","VoiceRecorder","recording","vmsgReady","LitElement","html","recordState","iconState","textState","css","String","Boolean","changedProperties","oldValue","propName","toggleRecording","newValue","pathFromUrl","decodeURIComponent","result","substring","lastIndexOf","customElements","define","tag"],"mappings":"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"}